summary: smoke test for the remote.exec tool

prepare: |
    tests.pkgs install sshpass
    useradd -m remote-user-1
    useradd -m remote-user-2
    echo remote-user-1:remote-user-1 | sudo chpasswd
    echo remote-user-2:remote-user-2 | sudo chpasswd

restore: |
    tests.pkgs remove sshpass

    killall -TERM -u remote-user-1
    userdel -r remote-user-1

    killall -TERM -u remote-user-2
    userdel -r remote-user-2
    rm -f remote.setup.cfg my-key my-key.pub

execute: |
    remote.exec --help | MATCH 'usage: remote.exec \[--user <USER>\] \[--pass <PASS>\] <CMD>'
    remote.exec -h | MATCH 'usage: remote.exec \[--user <USER>\] \[--pass <PASS>\] <CMD>'

    remote.setup config --host localhost --port 22 --user remote-user-1 --pass remote-user-1

    remote.exec "touch ~/testfile"
    test -f /home/remote-user-1/testfile

    remote.exec --user remote-user-2 --pass remote-user-2 "touch ~/testfile"
    test -f /home/remote-user-2/testfile

    remote.exec --user remote-user-2 --password remote-user-2 "touch ~/testfile" 2>&1 | MATCH "remote.exec: unknown option --password"

    # Check the remote execution using a certificate
    ssh-keygen -t rsa -N "" -f my-key
    chmod 0600 my-key my-key.pub

    mkdir -p /home/remote-user-1/.ssh
    cat my-key.pub > /home/remote-user-1/.ssh/authorized_keys
    
    remote.setup config --host localhost --port 22 --user remote-user-1 --cert my-key
    remote.exec "ls /home/remote-user-1/testfile" | MATCH testfile

    # Check error when there is no configuration
    rm -f remote.setup.cfg
    remote.exec --user remote-user-2 --pass remote-user-2 "touch ~/testfile" | MATCH "remote.exec: config file \"remote.setup.cfg\" not found, please run remote.setup command first"
