summary: tests for the repack-kernel tool

# ubuntu-core-initramfs seems to be only available on ubuntu-20.04
systems: [ubuntu-20.04-64]

prepare: |
    # install dependencies
    apt update -yqq
    apt install snapd

execute: |
    repack-kernel | MATCH 'usage: repack-kernel \[-h\] \[-c CUT\]'
    repack-kernel -h | MATCH 'usage: repack-kernel \[-h\] \[-c CUT\]'
    repack-kernel --help | MATCH 'usage: repack-kernel \[-h\] \[-c CUT\]'

    # verify error when calling without an invalid commnnd
    test "$(repack-kernel invalid-command 2>&1 | grep -c "no such command: invalid-command")" -eq 1

    # download the kernel snap
    snap download pc-kernel --channel=20/stable --basename=upstream-pc-kernel

    # setup dependencies
    repack-kernel setup

    # extract the kernel snap, including extracting the initrd from the kernel.efi
    kerneldir=/tmp/kernel-workdir
    repack-kernel extract "upstream-pc-kernel.snap" "$kerneldir"

    # cull modules and firmware
    repack-kernel cull-modules "$kerneldir"
    repack-kernel cull-firmware "$kerneldir"

    # repack the initrd into the kernel.efi
    repack-kernel prepare "$kerneldir"

    # repack the kernel snap itself
    repack-kernel pack "$kerneldir" --filename=pc-kernel.snap
    rm -rf "$kerneldir"

    if ![ -f "pc-kernel.snap" ]; then
        echo "Repack failed, pc-kernel.snap was not created"
        exit 1
    fi

restore: |
    apt remove snapd
